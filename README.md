# Course Allocation with Social Utility (HBS-style Draft + Friends)

Проект распределяет студентов по курсам при ограниченной вместимости курсов.
Студент выбирает курс не только по личным предпочтениям, но и с учётом друзей.

Алгоритм: **snake draft (HBS-style)** + (опционально) **post-phase улучшения**.

---

## 1) Данные (что на входе)

Есть:
- Students: S
- Courses: C
- Capacity: cap(c) — сколько мест в курсе c
- b — сколько курсов максимум может получить студент

Входные таблицы:
- Table 1: Individual preferences
  - PositionA(s,c) — ранг курса c для студента s (1 = лучший)
  - Score(s,c) — число для tie-break (не основной utility)
- Table 2: Friend preferences
  - PositionB(s,f,c) — насколько s хочет быть с другом f именно на курсе c (ранг)
- Table 3: Lambda
  - λ_s — насколько студенту важны друзья (social weight)

---

## 2) Главная формула (как студент оценивает курс)

При выборе курса c студент s считает:

U(s,c) = Base(s,c) + λ_s * FriendBonus(s,c)

Где:
- Base(s,c) — личная полезность курса
- FriendBonus(s,c) — бонус за друзей, которые УЖЕ находятся на этом курсе
- λ_s — вес дружбы для студента s

---

## 3) Как ранги превращаются в числа (Rank -> [0..1])

Используем функцию posU(p, K), которая переводит ранг p в число от 0 до 1:

posU(p, K) =
- 0, если p отсутствует (missing)
- 1, если K <= 1 и p = 1
- 0, если K <= 1 и p != 1
- (K - p) / (K - 1), если K > 1

Интуиция:
- лучший ранг (p=1) -> 1.0
- худший ранг (p=K) -> 0.0
- между ними — линейная шкала

### Мини-пример (K=5)
| p (rank) | posU(p,5) |
|---:|---:|
| 1 | 1.00 |
| 2 | 0.75 |
| 3 | 0.50 |
| 4 | 0.25 |
| 5 | 0.00 |

---

## 4) Компоненты utility

### 4.1 Base(s,c) — личная полезность курса
Берём PositionA(s,c) и переводим в [0..1]:

Base(s,c) = posU(PositionA(s,c), |C|)

Если у (s,c) нет позиции — Base=0.

### 4.2 Pref(s,f,c) — “насколько s хочет быть с другом f на курсе c”
Берём PositionB(s,f,c) и переводим в [0..1]:

Pref(s,f,c) = posU(PositionB(s,f,c), K_friend)

K_friend — размер шкалы рангов друзей (обычно число позиций/друзей в таблице).

### 4.3 FriendBonus(s,c) — реактивный бонус (IMPORTANT)
Это “reactive”: учитываются только те друзья, кто УЖЕ получил курс c.

FriendBonus(s,c) = sum over f in Friends(s):
  I[c in A_f] * Pref(s,f,c)

Где:
- A_f — текущий набор курсов друга f
- I[условие] = 1 если условие true, иначе 0

---

## 5) Какие курсы можно выбрать (feasible set)

Студент не может:
- взять курс без мест
- взять курс, который у него уже есть

Feasible(s) = { c in C : cap_left(c) > 0 AND c not in A_s }

---

## 6) Как выбирается курс (tie-break)

Алгоритм выбирает курс с максимальным “ключом” (lexicographic max):

Key(s,c) = (
  round(U(s,c), 9),
  -PositionA(s,c),
  Score(s,c),
  rnd(s,c),
  CourseID(c)
)

То есть:
1) максимизируем U(s,c) (с округлением)
2) если равны — лучше меньший PositionA (поэтому стоит минус)
3) если равны — больше Score
4) если равны — seeded random
5) если равны — стабильный CourseID

---

## 7) Phase A: HBS snake draft

1) Перемешиваем студентов фиксированным seed
2) Делаем draft_rounds раундов
3) В нечётных раундах порядок прямой, в чётных — обратный (snake)
4) Каждый студент делает 1 pick по правилам выше

---

## 8) Post-phase улучшения (опционально)

### Mode = swap (локальный поиск)
Пробуем обменять курсы между двумя студентами, если это улучшает глобальное welfare.

Welfare студента s по итоговой аллокации:

W_s = sum over c in A_s:
  Base(s,c) + λ_s * sum over f in Friends(s): I[c in A_f] * Pref(s,f,c)

Глобально:
W = sum over s in S: W_s

Swap применяем только если deltaW = W_new - W_old > 0.

### Mode = add-drop (HBS-style)
Проходим студентов в случайном порядке и пересобираем им лучший набор из:
- уже имеющихся курсов
- плюс курсы с оставшейся вместимостью

Оставляем top-b курсов по U(s,c).

---

## 9) Метрики (что считаем на выходе)

Считаем:
- total utility / base utility / friend utility
- нормализованные utility (0..1)
- Gini по нормализованной total/base полезности
- заполнение курсов, friend-overlap и др.

---

## 10) Quick start

Пример генерации таблиц:
```bash
python generate/generate_tables.py --students 200 --courses 8 --seed 42
